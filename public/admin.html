<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Administraci√≥n</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 15px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    .card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      padding: clamp(20px, 4vw, 30px);
      margin-bottom: 20px;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: clamp(1.5rem, 5vw, 2rem);
      line-height: 1.2;
    }

    h2 {
      color: #555;
      margin-bottom: 20px;
      font-size: clamp(1.2em, 4vw, 1.5em);
    }

    .welcome {
      color: #667eea;
      font-size: clamp(0.95em, 3vw, 1.1em);
      margin-bottom: 20px;
      word-wrap: break-word;
    }

    /* Login Form */
    #loginSection {
      max-width: 400px;
      margin: clamp(30px, 15vh, 100px) auto;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 600;
      font-size: clamp(0.9rem, 3vw, 1rem);
    }

    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: clamp(10px, 2vw, 12px);
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: clamp(0.9em, 3vw, 1em);
      transition: border-color 0.3s ease;
    }

    input[type="text"]:focus,
    input[type="password"]:focus {
      outline: none;
      border-color: #667eea;
    }

    button {
      padding: clamp(10px, 2vw, 12px) clamp(20px, 4vw, 30px);
      border: none;
      border-radius: 8px;
      font-size: clamp(0.9em, 3vw, 1em);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      touch-action: manipulation;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      width: 100%;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      color: white;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #666;
    }

    .btn-success:hover,
    .btn-danger:hover,
    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    }

    /* Status Card */
    .status-display {
      padding: clamp(20px, 4vw, 25px);
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
      font-size: clamp(1em, 3vw, 1.2em);
      line-height: 1.4;
    }

    .status-display.available {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      color: white;
    }

    .status-display.occupied {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      color: white;
    }

    .status-display .icon {
      font-size: clamp(2em, 8vw, 2.5em);
      margin-bottom: 10px;
    }

    .button-group {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 20px;
    }

    .button-group button {
      flex: 1;
      min-height: 44px;
    }

    /* Admin List */
    .admin-list {
      margin-top: 20px;
    }

    .admin-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .admin-info {
      display: flex;
      flex-direction: column;
    }

    .admin-name {
      font-weight: 600;
      color: #333;
      font-size: clamp(0.95rem, 3vw, 1rem);
    }

    .admin-date {
      font-size: clamp(0.8em, 2.5vw, 0.85em);
      color: #999;
      margin-top: 5px;
    }

    .btn-delete {
      background: #ff4757;
      color: white;
      padding: clamp(6px, 2vw, 8px) clamp(12px, 3vw, 15px);
      font-size: clamp(0.85em, 2.5vw, 0.9em);
      white-space: nowrap;
    }

    .btn-delete:hover {
      background: #ee5a6f;
    }

    /* Messages */
    .message {
      padding: 12px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      animation: slideIn 0.3s ease;
    }

    .message.error {
      background: #ffe5e5;
      color: #d63031;
      border-left: 4px solid #d63031;
    }

    .message.success {
      background: #e5ffe5;
      color: #00b894;
      border-left: 4px solid #00b894;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .hidden {
      display: none;
    }

    .back-link {
      margin-top: 20px;
      text-align: center;
    }

    .back-link a {
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
      font-size: clamp(0.85rem, 3vw, 0.95rem);
    }

    .back-link a:hover {
      text-decoration: underline;
    }

    .logout-btn {
      background: none;
      border: none;
      color: #667eea;
      cursor: pointer;
      text-decoration: underline;
      font-size: clamp(0.85em, 2.5vw, 0.9em);
      padding: 5px;
      width: auto;
      min-height: auto;
    }

    .header-actions {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 15px;
      padding: clamp(20px, 4vw, 30px);
      max-width: 400px;
      width: 90%;
    }

    .modal-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 20px;
    }

    .modal-buttons button {
      flex: 1;
      min-height: 44px;
    }

    /* Responsive Design */
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }

      .card {
        border-radius: 12px;
      }

      .admin-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .btn-delete {
        width: 100%;
      }
    }

    @media (min-width: 481px) and (max-width: 768px) {
      .button-group {
        flex-direction: row;
      }

      .modal-buttons {
        flex-direction: row;
      }
    }

    @media (min-width: 769px) {
      body {
        padding: 20px;
      }

      .button-group {
        flex-direction: row;
      }

      .modal-buttons {
        flex-direction: row;
      }

      .header-actions {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
    }

    /* Touch improvements for mobile */
    @media (hover: none) and (pointer: coarse) {
      button {
        min-height: 44px;
      }

      input[type="text"],
      input[type="password"] {
        min-height: 44px;
      }
    }
  </style>
</head>
<body>
  <!-- Login Section -->
  <div id="loginSection" class="card">
    <h1>üîê Acceso Administrador</h1>
    <p style="color: #666; margin: 20px 0;">Ingresa tus credenciales para acceder al panel</p>
    
    <div id="loginMessage"></div>
    
    <form id="loginForm">
      <div class="form-group">
        <label for="username">Usuario</label>
        <input type="text" id="username" required autocomplete="username">
      </div>
      
      <div class="form-group">
        <label for="password">Contrase√±a</label>
        <input type="password" id="password" required autocomplete="current-password">
      </div>
      
      <button type="submit" class="btn-primary">Iniciar Sesi√≥n</button>
    </form>

    <div class="back-link">
      <a href="/">‚Üê Volver a la vista p√∫blica</a>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="hidden">
    <div class="card">
      <div class="header-actions">
        <div>
          <h1>Panel de Administraci√≥n</h1>
          <p class="welcome">Bienvenido, <span id="adminUsername"></span></p>
        </div>
        <button class="logout-btn" onclick="logout()">Cerrar sesi√≥n</button>
      </div>

      <div id="adminMessage"></div>

      <!-- Status Control -->
      <div class="status-display" id="statusDisplay">
        <div class="icon">‚è≥</div>
        <div>Cargando estado...</div>
      </div>

      <div class="button-group">
        <button class="btn-success" onclick="occupyRoom()">‚úÖ Marcar: Estoy Dentro (acceso permitido)</button>
        <button class="btn-danger" onclick="releaseRoom()">üî¥ Marcar: He Salido (acceso cerrado)</button>
      </div>

      <div class="back-link">
        <a href="/">‚Üê Ver vista p√∫blica</a>
      </div>
    </div>

    <!-- Admin Management -->
    <div class="card">
      <h2>Gesti√≥n de Administradores</h2>
      
      <button class="btn-primary" onclick="showCreateAdminModal()">‚ûï Crear Nuevo Administrador</button>
      
      <div class="admin-list" id="adminList">
        <p style="color: #999;">Cargando administradores...</p>
      </div>
    </div>
  </div>

  <!-- Create Admin Modal -->
  <div id="createAdminModal" class="modal">
    <div class="modal-content">
      <h2>Crear Administrador</h2>
      
      <div id="modalMessage"></div>
      
      <div class="form-group">
        <label for="newUsername">Usuario</label>
        <input type="text" id="newUsername" autocomplete="off">
      </div>
      
      <div class="form-group">
        <label for="newPassword">Contrase√±a (m√≠n. 6 caracteres)</label>
        <input type="password" id="newPassword" autocomplete="new-password">
      </div>
      
      <div class="modal-buttons">
        <button class="btn-secondary" onclick="hideCreateAdminModal()">Cancelar</button>
        <button class="btn-primary" onclick="createAdmin()">Crear</button>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;

    // Check authentication on load
    checkAuth();

    async function checkAuth() {
      try {
        const response = await fetch('/api/verify');
        if (response.ok) {
          const data = await response.json();
          currentUser = data.username;
          showAdminPanel();
        } else {
          showLoginForm();
        }
      } catch (error) {
        showLoginForm();
      }
    }

    function showLoginForm() {
      document.getElementById('loginSection').classList.remove('hidden');
      document.getElementById('adminPanel').classList.add('hidden');
    }

    function showAdminPanel() {
      document.getElementById('loginSection').classList.add('hidden');
      document.getElementById('adminPanel').classList.remove('hidden');
      document.getElementById('adminUsername').textContent = currentUser;
      loadStatus();
      loadAdmins();
    }

    // Login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (response.ok) {
          currentUser = data.username;
          showAdminPanel();
        } else {
          showMessage('loginMessage', data.error, 'error');
        }
      } catch (error) {
        showMessage('loginMessage', 'Error de conexi√≥n', 'error');
      }
    });

    // Logout
    async function logout() {
      await fetch('/api/logout', { method: 'POST' });
      currentUser = null;
      showLoginForm();
    }

    // Load Status
    async function loadStatus() {
      try {
        const response = await fetch('/api/status');
        const data = await response.json();
        updateStatusDisplay(data);
      } catch (error) {
        console.error('Error al cargar estado:', error);
      }
    }

    function updateStatusDisplay(data) {
      const display = document.getElementById('statusDisplay');
      
      if (data.isOccupied) {
        display.className = 'status-display available';
        display.innerHTML = `
          <div class="icon">‚úÖ</div>
          <div><strong>EST√ÅS DENTRO - OTROS PUEDEN ACCEDER</strong></div>
          <div style="margin-top: 10px;">Por: ${data.occupiedBy}</div>
        `;
      } else {
        display.className = 'status-display occupied';
        display.innerHTML = `
          <div class="icon">üî¥</div>
          <div><strong>NADIE HA ACCEDIDO - SALA CERRADA</strong></div>
        `;
      }
    }

    // Occupy Room
    async function occupyRoom() {
      try {
        const response = await fetch('/api/occupy', { method: 'POST' });
        const data = await response.json();
        
        if (response.ok) {
          showMessage('adminMessage', '‚úÖ Marcado como "Estoy dentro" - Otros pueden acceder', 'success');
          loadStatus();
        } else {
          showMessage('adminMessage', data.error, 'error');
        }
      } catch (error) {
        showMessage('adminMessage', 'Error de conexi√≥n', 'error');
      }
    }

    // Release Room
    async function releaseRoom() {
      try {
        const response = await fetch('/api/release', { method: 'POST' });
        const data = await response.json();
        
        if (response.ok) {
          showMessage('adminMessage', 'üî¥ Marcado como "He salido" - Acceso cerrado', 'success');
          loadStatus();
        } else {
          showMessage('adminMessage', data.error, 'error');
        }
      } catch (error) {
        showMessage('adminMessage', 'Error de conexi√≥n', 'error');
      }
    }

    // Load Admins
    async function loadAdmins() {
      try {
        const response = await fetch('/api/admins');
        const admins = await response.json();
        
        const list = document.getElementById('adminList');
        
        if (admins.length === 0) {
          list.innerHTML = '<p style="color: #999;">No hay administradores</p>';
          return;
        }
        
        list.innerHTML = admins.map(admin => `
          <div class="admin-item">
            <div class="admin-info">
              <div class="admin-name">üë§ ${admin.username}</div>
              <div class="admin-date">Creado: ${new Date(admin.created_at).toLocaleDateString('es-ES')}</div>
            </div>
            ${admin.username !== currentUser ? 
              `<button class="btn-delete" onclick="deleteAdmin(${admin.id}, '${admin.username}')">Eliminar</button>` 
              : '<span style="color: #667eea; font-size: 0.9em;">T√∫</span>'}
          </div>
        `).join('');
      } catch (error) {
        console.error('Error al cargar administradores:', error);
      }
    }

    // Modal functions
    function showCreateAdminModal() {
      document.getElementById('createAdminModal').classList.add('active');
      document.getElementById('newUsername').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('modalMessage').innerHTML = '';
    }

    function hideCreateAdminModal() {
      document.getElementById('createAdminModal').classList.remove('active');
    }

    // Create Admin
    async function createAdmin() {
      const username = document.getElementById('newUsername').value;
      const password = document.getElementById('newPassword').value;

      if (!username || !password) {
        showMessage('modalMessage', 'Complete todos los campos', 'error');
        return;
      }

      try {
        const response = await fetch('/api/admins', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (response.ok) {
          hideCreateAdminModal();
          showMessage('adminMessage', '‚úÖ Administrador creado exitosamente', 'success');
          loadAdmins();
        } else {
          showMessage('modalMessage', data.error, 'error');
        }
      } catch (error) {
        showMessage('modalMessage', 'Error de conexi√≥n', 'error');
      }
    }

    // Delete Admin
    async function deleteAdmin(id, username) {
      if (!confirm(`¬øEliminar al administrador "${username}"?`)) {
        return;
      }

      try {
        const response = await fetch(`/api/admins/${id}`, { method: 'DELETE' });
        const data = await response.json();

        if (response.ok) {
          showMessage('adminMessage', '‚úÖ Administrador eliminado', 'success');
          loadAdmins();
        } else {
          showMessage('adminMessage', data.error, 'error');
        }
      } catch (error) {
        showMessage('adminMessage', 'Error de conexi√≥n', 'error');
      }
    }

    // Utility function to show messages
    function showMessage(containerId, message, type) {
      const container = document.getElementById(containerId);
      container.innerHTML = `<div class="message ${type}">${message}</div>`;
      setTimeout(() => container.innerHTML = '', 5000);
    }

    // Auto-refresh status every 10 seconds
    setInterval(loadStatus, 10000);
  </script>
</body>
</html>
